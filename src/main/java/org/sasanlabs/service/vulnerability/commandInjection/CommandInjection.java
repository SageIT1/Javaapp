package org.sasanlabs.service.vulnerability.commandInjection;

import java.io.IOException;
import java.net.InetAddress;
import java.util.regex.Pattern;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class CommandInjection {

    private static final String IP_ADDRESS = "ipaddress";
    private static final Pattern IP_V4_PATTERN = Pattern.compile(
        "^((25[0-5]|(2[0-4]|1\\d|[1-9]|)\\d)\\.?\\b){4}$"
    );
    private static final Pattern IP_V6_PATTERN = Pattern.compile(
        "^([0-9a-fA-F]{0,4}:){7}[0-9a-fA-F]{0,4}$"
    );
    private static final Pattern HOSTNAME_PATTERN = Pattern.compile(
        "^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$"
    );

    public ResponseEntity<String> executePingCommand(
            @RequestParam(IP_ADDRESS) String ipAddress) throws IOException {
        
        String result = performSafePing(ipAddress);
        if (result == null) {
            return new ResponseEntity<>("Invalid IP address or hostname", HttpStatus.BAD_REQUEST);
        }
        return new ResponseEntity<>(result, HttpStatus.OK);
    }

    public ResponseEntity<String> executePingCommandWithBasicValidation(
            @RequestParam(IP_ADDRESS) String ipAddress) throws IOException {
        
        String result = performSafePing(ipAddress);
        if (result == null) {
            return new ResponseEntity<>("Invalid IP address or hostname", HttpStatus.BAD_REQUEST);
        }
        return new ResponseEntity<>(result, HttpStatus.OK);
    }

    private String performSafePing(String target) {
        if (target == null || target.trim().isEmpty()) {
            return null;
        }
        
        target = target.trim();
        
        if (!isValidTarget(target)) {
            return null;
        }
        
        try {
            InetAddress address = InetAddress.getByName(target);
            boolean reachable = address.isReachable(5000);
            
            StringBuilder result = new StringBuilder();
            result.append("Ping statistics for ").append(target).append(":\n");
            result.append("Host: ").append(address.getHostAddress()).append("\n");
            
            if (reachable) {
                result.append("Status: Host is reachable\n");
                result.append("Reply from ").append(address.getHostAddress()).append(": bytes=32 time<5000ms\n");
            } else {
                result.append("Status: Host is not reachable (timeout after 5000ms)\n");
            }
            
            return result.toString();
        } catch (IOException e) {
            return "Error: Unable to resolve or ping host - " + e.getMessage();
        }
    }

    private boolean isValidTarget(String target) {
        if (target.length() > 253) {
            return false;
        }
        
        if (IP_V4_PATTERN.matcher(target).matches() || 
            IP_V6_PATTERN.matcher(target).matches() ||
            HOSTNAME_PATTERN.matcher(target).matches()) {
            return true;
        }
        
        return false;
    }
}
